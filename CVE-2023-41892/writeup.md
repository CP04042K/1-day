![image](https://github.com/CP04042K/1-day/assets/35491855/97d9023a-348c-49dc-ba1e-e6b4b23f090d)## Introduction 
A short writeup about **CVE-2023-41892**, an unauthenticated RCE in CraftCMS. Root cause of the vulnerability is an Arbitrary Object Instantiation that allow attack to construct an Object with data provided in POST data. The instantiation occure **before** the authentication check happend, which make this vulnerability so critical.

## Technical detail
First let's look how CraftCMS process a request we make to do somethings like update email settings or Fields setting. 

The request meet the `Controller` class, which will then decide which which method from which class would be called, the process is devided into three step, `beforeAction`, run the action and `afterAction`.

### Patch analysis
The patch create a new method `cleanseConfig` which remove any attributes that start with `as ` and `on ` and then call this method to clean the data from the `config` post data in `ConditionsController` 

![image](https://github.com/CP04042K/1-day/assets/35491855/716d4858-27a4-4477-aca5-c47f9361a29b)

### The sink
```
Craft::configure($this->_condition, $baseConfig);
```
Drilling down to the `configure` call, we find that what it do is assigning properties from `$baseConfig` to `$this->_condition` (An object that is instantiated throught a class name, but have to be a class that implements the `ConditionInterface`)

We know that we can abuse the `__set` function from class `yii\base\Component` and send a attribute with `as ...` to reach the `createObject`
![image](https://github.com/CP04042K/1-day/assets/35491855/66559084-77ef-4eb9-b0ea-05dcab71f9d7)

Class `UserCondition` as a choice, it `extends` the `ElementCondition` which eventually `extends` the `Components` class. So the stradegy is simple, we instantiate the `craft\elements\conditions\users\UserCondition` and assign to `_condition`, append the json in `baseConfig` with 
```
"as session":{"class":"...","__construct()":[{"...":"..."}
```
### RCE
So now we know how to construct an arbitrary object, but what object to construct? If you do some search for a while, you will see that the `__constructor` magic function in `yii\rbac\PhpManager` will eventually call to an `include`, and the file name for inclusion can be overriden from the constructor also. We also know that CraftCMS create log files, the file name can be predicted, by poisoning the log and include it, we can archive an RCE. 
```
"as session":{"class":"yii\\rbac\\PhpManager","__construct()":[{"itemFile":"../storage/logs/web-2023-10-05.log"}
```
![image](https://github.com/CP04042K/1-day/assets/35491855/02f82414-5c92-4464-8dc1-eb81503769fa)
### RCE 2
Another way is to combine both the PHP behavior that create temporary file and use the Imagick constructor to process an MSL file that write a php file in document root for us
```
"as session":{"class":"Imagic","__construct()":["vid:msl:/tmp/php*"]}
```
